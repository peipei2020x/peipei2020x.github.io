<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERING - Official Portal</title>
    <meta name="description" content="peipeiが創造するプロジェクトへの入り口。">
    <style>
        /* 
        ==========================================================================
        CSS (カスケーディング・スタイル・シート)
        ==========================================================================
        */

        :root {
            --font-family-sans: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            --font-family-mono: 'SF Mono', 'Consolas', 'Menlo', monospace;

            /* ライトテーマ */
            --color-text-light: #2c3e50;
            --color-bg-light: #ecf0f1;
            --color-primary-light: #3498db;
            --color-secondary-light: #9b59b6;
            --color-card-bg-light: rgba(255, 255, 255, 0.7);
            --color-card-border-light: #bdc3c7;
            --color-shadow-light: rgba(44, 62, 80, 0.15);
            --color-header-bg-light: rgba(236, 240, 241, 0.85);

            /* ダークテーマ */
            --color-text-dark: #ecf0f1;
            --color-bg-dark: #1a1a2e;
            --color-primary-dark: #00a8ff;
            --color-secondary-dark: #f0c419;
            --color-card-bg-dark: rgba(26, 26, 46, 0.6);
            --color-card-border-dark: rgba(0, 168, 255, 0.3);
            --color-shadow-dark: rgba(0, 0, 0, 0.5);
            --color-header-bg-dark: rgba(26, 26, 46, 0.85);

            --header-height: 70px;
            --border-radius: 12px;
            --transition-speed: 0.4s;
        }

        :root,
        :root.light-theme {
            --color-text: var(--color-text-light);
            --color-bg: var(--color-bg-light);
            --color-primary: var(--color-primary-light);
            --color-secondary: var(--color-secondary-light);
            --color-card-bg: var(--color-card-bg-light);
            --color-card-border: var(--color-card-border-light);
            --color-shadow: var(--color-shadow-light);
            --color-header-bg: var(--color-header-bg-light);
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        :root.dark-theme {
            --color-text: var(--color-text-dark);
            --color-bg: var(--color-bg-dark);
            --color-primary: var(--color-primary-dark);
            --color-secondary: var(--color-secondary-dark);
            --color-card-bg: var(--color-card-bg-dark);
            --color-card-border: var(--color-card-border-dark);
            --color-shadow: var(--color-shadow-dark);
            --color-header-bg: var(--color-header-bg-dark);
            --background-gradient: linear-gradient(135deg, #16222A 0%, #3A6073 100%);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-family-sans); background-color: var(--color-bg); color: var(--color-text); line-height: 1.7; overflow-x: hidden; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--background-gradient); z-index: -2; transition: background var(--transition-speed) ease; }
        
        #cursor-aura { position: fixed; width: 400px; height: 400px; background: radial-gradient(circle, var(--color-primary) 0%, rgba(255,255,255,0) 60%); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: -1; opacity: 0.1; transition: background 0.2s linear, transform 0.1s ease-out; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; padding: 2rem 0; }

        .site-header { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); display: flex; justify-content: center; align-items: center; background-color: var(--color-header-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 10px var(--color-shadow); z-index: 1000; transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .header-content { display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 1200px; }
        .logo { font-size: 1.8rem; font-weight: bold; color: var(--color-primary); text-decoration: none; letter-spacing: 2px; transition: color var(--transition-speed) ease; cursor: pointer; user-select: none; }
        #realtime-clock { font-family: var(--font-family-mono); font-size: 1.1rem; color: var(--color-text); opacity: 0.8; transition: color var(--transition-speed) ease; }
        .theme-switcher { background: none; border: 2px solid var(--color-primary); color: var(--color-primary); padding: 8px 12px; border-radius: 50px; cursor: pointer; font-size: 1rem; transition: all var(--transition-speed) ease; }
        .theme-switcher:hover { background: var(--color-primary); color: var(--color-bg); }

        .hero { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 100vh; padding-top: var(--header-height); position: relative; }
        .hero-title { font-size: 4rem; font-weight: 800; margin-bottom: 1rem; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeInDown 1s ease-out; }
        .hero-subtitle { font-size: 1.5rem; margin-bottom: 2rem; color: var(--color-text); opacity: 0.8; animation: fadeInUp 1s ease-out 0.5s; animation-fill-mode: backwards; }
        .scroll-down-indicator { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 2rem; color: var(--color-primary); animation: bounce 2s infinite; }

        .section { padding: 60px 0; }
        .section:last-of-type { padding-bottom: 0; }
        .section-title { font-size: 2.5rem; text-align: center; margin-bottom: 3rem; color: var(--color-primary); font-weight: 700; position: relative; }
        .section-title::after { content: ''; display: block; width: 80px; height: 4px; background-color: var(--color-secondary); margin: 0.5rem auto 0; border-radius: 2px; }
        
        .portal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .portal-card { background-color: var(--color-card-bg); border: 1px solid var(--color-card-border); border-radius: var(--border-radius); padding: 2rem; box-shadow: 0 8px 32px 0 var(--color-shadow); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); text-decoration: none; color: var(--color-text); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease; opacity: 0; transform: translateY(30px); }
        .portal-card.visible { opacity: 1; transform: translateY(0); }
        .portal-card:hover { transform: translateY(-10px); box-shadow: 0 16px 40px 0 var(--color-shadow); border-color: var(--color-primary); }

        .card-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--color-primary); }
        .card-title { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--color-text); font-weight: 600; }
        .card-description { font-size: 1rem; opacity: 0.8; margin-bottom: 1.5rem; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .card-tag { background-color: rgba(0, 168, 255, 0.1); color: var(--color-primary); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem; font-weight: 500; }

        .utility-section { background-color: var(--color-card-bg); border: 1px solid var(--color-card-border); border-radius: var(--border-radius); padding: 2rem; margin-top: 4rem; }
        .utility-content { margin-bottom: 2rem; }
        .utility-content:last-child { margin-bottom: 0; }
        .utility-content h3 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--color-primary); }
        .utility-content p { margin-bottom: 1.5rem; }
        
        .search-form-container { display: flex; gap: 1rem; }
        .search-form-container input[type="search"] { flex-grow: 1; padding: 0.75rem 1rem; border-radius: 50px; border: 1px solid var(--color-card-border); background-color: var(--color-bg); color: var(--color-text); font-size: 1rem; transition: all var(--transition-speed) ease; }
        .search-form-container input[type="search"]:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.2); }
        .search-form-container .btn { flex-shrink: 0; }

        .btn { background-color: var(--color-secondary); color: #fff; padding: 0.75rem 1.5rem; border: none; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: 500; text-decoration: none; display: inline-block; transition: all var(--transition-speed) ease; }
        .btn:hover { background-color: var(--color-primary); transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        #terms-of-service { margin-top: 2rem; }
        .terms-details { border: 1px solid var(--color-card-border); border-radius: var(--border-radius); margin-bottom: 1rem; }
        .terms-summary { padding: 1rem; font-size: 1.2rem; font-weight: 600; cursor: pointer; outline: none; color: var(--color-primary); }
        .terms-content { padding: 0 1rem 1rem 1rem; border-top: 1px solid var(--color-card-border); opacity: 0.8; }

        .site-footer { text-align: center; padding: 2rem 0; margin-top: 4rem; border-top: 1px solid var(--color-card-border); }
        
        .settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 2000; visibility: hidden; opacity: 0; transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed) linear; }
        .settings-modal.is-open { visibility: visible; opacity: 1; transition-delay: 0s; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); cursor: pointer; }
        .modal-content { position: relative; background-color: var(--color-card-bg); padding: 2rem; border-radius: var(--border-radius); border: 1px solid var(--color-card-border); box-shadow: 0 16px 40px 0 var(--color-shadow); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); max-width: 600px; width: 90%; text-align: left; transform: scale(0.9); transition: transform var(--transition-speed) ease; max-height: 80vh; overflow-y: auto; }
        .settings-modal.is-open .modal-content { transform: scale(1); }
        .modal-content h2 { font-size: 2rem; color: var(--color-primary); margin-bottom: 1.5rem; text-align: center; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 2rem; color: var(--color-text); background: none; border: none; cursor: pointer; opacity: 0.7; transition: opacity var(--transition-speed) ease; line-height: 1; }
        .modal-close-btn:hover { opacity: 1; }
        .settings-section { margin-bottom: 2rem; border-bottom: 1px solid var(--color-card-border); padding-bottom: 1.5rem; }
        .settings-section:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
        .settings-section h3 { font-size: 1.3rem; margin-bottom: 1rem; color: var(--color-secondary); }
        .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .settings-input, .settings-select, .settings-textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--color-card-border); background-color: var(--color-bg); color: var(--color-text); font-size: 1rem; transition: all var(--transition-speed) ease; }
        .settings-input:focus, .settings-select:focus, .settings-textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.2); }
        .settings-textarea { min-height: 100px; resize: vertical; }
        .form-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .form-row > * { flex: 1; }
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .shortcuts-list { list-style: none; padding: 0; }
        .shortcut-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.1); padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
        .shortcut-item a { color: var(--color-primary); text-decoration: none; font-weight: bold; }
        .shortcut-item button { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; }

        #relax-view-layer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 3000; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; cursor: pointer; visibility: hidden; opacity: 0; transition: all var(--transition-speed) ease; }
        #relax-view-layer.is-open { visibility: visible; opacity: 1; }
        #relax-view-layer img, #relax-view-layer video { max-width: 95vw; max-height: 95vh; object-fit: contain; cursor: default; }
        
        #relax-view-file-info { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.9rem; }
        #relax-view-file-info span { max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #clear-relax-file-btn { background: none; border: 1px solid #e74c3c; color: #e74c3c; font-size: 0.8rem; padding: 0.1rem 0.5rem; border-radius: 4px; cursor: pointer; }

        .is-hidden { display: none !important; }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translate(-50%, 0); } 40% { transform: translate(-50%, -20px); } 60% { transform: translate(-50%, -10px); } }
        
        @media (max-width: 768px) {
            html { font-size: 14px; }
            .header-content { flex-wrap: wrap; justify-content: space-between; }
            #realtime-clock { order: 3; width: 100%; text-align: center; margin-top: -10px; font-size: 0.9rem; }
            .hero-title { font-size: 3rem; }
            .hero-subtitle { font-size: 1.2rem; }
            .section-title { font-size: 2rem; }
            .portal-grid { grid-template-columns: 1fr; }
            .search-form-container { flex-direction: column; }
            .form-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="cursor-aura"></div>

    <header class="site-header">
        <div class="header-content">
            <a class="logo">PERING</a>
            <div id="realtime-clock"></div>
            <button id="theme-switcher" class="theme-switcher">テーマ切替</button>
        </div>
    </header>

    <main>
        <section class="hero"> <h1 class="hero-title">Portal of Creation</h1> <p class="hero-subtitle">peipeiが創造する世界へようこそ。</p> <a href="#main-projects" class="scroll-down-indicator"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="7 13 12 18 17 13"></polyline><polyline points="7 6 12 11 17 6"></polyline></svg> </a> </section>
        <section id="main-projects" class="section"> <div class="container"> <h2 class="section-title">Main Projects</h2> <div id="main-projects-grid" class="portal-grid"></div> </div> </section>
        <section id="fun-projects" class="section"> <div class="container"> <h2 class="section-title">Lab & Fun Projects</h2> <div id="fun-projects-grid" class="portal-grid"></div> </div> </section>
        
        <section id="utility" class="section">
            <div class="container">
                <h2 class="section-title">Utility</h2>
                <div class="utility-section">
                    <div id="google-search-section" class="utility-content">
                        <h3>Search the Web</h3>
                        <p>気になることがあれば、ここからすぐにウェブ検索ができます。</p>
                        <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer" class="search-form-container">
                            <input type="search" name="q" placeholder="Googleで検索..." required>
                            <button type="submit" class="btn">検索</button>
                        </form>
                    </div>

                    <div class="utility-content">
                        <h3>専用区画 (ユーザーデータ管理)</h3>
                        <p>このウェブサイトでは、閲覧体験向上のため、テーマや各種カスタム設定をブラウザに保存します。以下のボタンで全設定をリセットできます。</p>
                        <button id="clear-storage-button" class="btn">全設定をリセット</button>
                    </div>

                    <div id="terms-of-service">
                        <h3>利用規約</h3>
                        <p>当サイトをご利用いただく前に、以下の利用規約をよくお読みください。</p>
                        <details class="terms-details"><summary class="terms-summary">第1章 総則</summary><div class="terms-content"><p><strong>第1条 (本規約の適用範囲)</strong><br>本利用規約（以下、「本規約」といいます。）は、peipei（以下、「当サイト運営者」といいます。）が提供するこのポータルサイト（以下、「本サイト」といいます。）の利用に関する条件を定めるものです。本サイトを利用するすべてのユーザー（以下、「ユーザー」といいます。）は、本サイトを利用することにより、本規約のすべての内容に同意したものとみなされます。</p><p><strong>第2条 (本規約とGitHub利用規約)</strong><br>本サイトはGitHub Pagesのサービスを利用して公開されています。そのため、本サイトの利用にあたっては、本規約に加えて、GitHubの利用規約が適用されます。本規約とGitHubの利用規約との間に矛盾が生じた場合は、GitHubの利用規約が優先されるものとします。</p><p><strong>第3条 (本規約の変更)</strong><br>当サイト運営者は、ユーザーへの事前の通知なく、いつでも本規約を変更できるものとします。変更後の本規約は、本サイト上に掲載された時点から効力を生じるものとし、ユーザーが本規約の変更後も本サイトの利用を継続する場合、変更後の本規約に同意したものとみなします。</p></div></details>
                        <details class="terms-details"><summary class="terms-summary">第2章 サイトの利用</summary><div class="terms-content"><p><strong>第4条 (知的財産権について)</strong><br>本サイトを構成するコンテンツ（テキスト、画像、コード等）について、当サイト運営者は最低限しか著作権を主張しません。本サイトのコンテンツの多くはAIによって生成されたものであり、ユーザーは自己の責任において法律で認められる範囲で自由に利用することができます。ただし、各リンク先のプロジェクトコンテンツについては、それぞれのプロジェクトが定めるライセンスに従うものとします。</p><p><strong>第5条 (禁止事項)</strong><br>ユーザーは、本サイトの利用にあたり、以下の行為をしてはなりません。<br>1. 法令または規約に違反する行為<br>2. 犯罪行為に関連する行為<br>3. 本サイトのサーバーやネットワークの機能を破壊したり、妨害したりする行為<br>4. 本サイトの運営を妨害するおそれのある行為<br>5. その他、当サイト運営者が不適切と判断する行為</p></div></details>
                         <details class="terms-details"><summary class="terms-summary">第3章 免責事項</summary><div class="terms-content"><p><strong>第6条 (保証の否認および免責事項)</strong><br>1. 当サイト運営者は、本サイトに事実上または法律上の瑕疵（安全性、信頼性、正確性、完全性、有効性、特定の目的への適合性、セキュリティなどに関する欠陥、エラーやバグ、権利侵害などを含みます。）がないことを、明示的にも黙示的にも保証しておりません。<br>2. 当サイト運営者は、本サイトに起因してユーザーに生じたいかなる損害についても、一切の責任を負いません。本サイトの利用は、すべてユーザー自身の責任において行うものとします。<br>3. 本サイトからリンクによって移動できる第三者のウェブサイト、およびそのコンテンツやサービスについて、当サイト運営者はその内容を保証するものではなく、一切の責任を負いません。リンク先のウェブサイトは、それぞれの運営者の責任によって管理されており、ユーザーは自身の責任でこれを利用するものとします。<br>4. 当サイト運営者は、ユーザーへの予告なく、本サイトの内容を変更、中断、または終了することができます。これによってユーザーに何らかの不利益や損害が生じた場合でも、当サイト運営者は責任を負わないものとします。</p></div></details>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="site-footer">
        <p>&copy; <span id="current-year"></span> peipei. All Rights Reserved.</p>
    </footer>

    <div id="settings-modal" class="settings-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>設定パネル</h2>

            <!-- 表示設定 -->
            <div class="settings-section">
                <h3>表示設定</h3>
                <div class="toggle-switch">
                    <label for="toggle-clock">リアルタイムクロックを表示</label>
                    <input type="checkbox" id="toggle-clock">
                </div>
                <div class="toggle-switch">
                    <label for="toggle-search">Google検索フォームを表示</label>
                    <input type="checkbox" id="toggle-search">
                </div>
            </div>

            <!-- リラックスビュー設定 -->
            <div class="settings-section">
                <h3>リラックスビュー</h3>
                <div class="toggle-switch">
                    <label for="toggle-relax-view-enabled">機能を有効にする</label>
                    <input type="checkbox" id="toggle-relax-view-enabled">
                </div>
                <div class="toggle-switch" style="margin-top: 1rem;">
                    <label for="toggle-relax-audio">動画の音声を再生する</label>
                    <input type="checkbox" id="toggle-relax-audio">
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <div>
                        <label class="settings-label" for="relax-trigger-select">起動方式</label>
                        <select id="relax-trigger-select" class="settings-select">
                            <option value="toggle">切り替え</option>
                            <option value="hold">長押し</option>
                        </select>
                    </div>
                    <div>
                        <label class="settings-label" for="relax-key-input">起動キー</label>
                        <input type="text" id="relax-key-input" class="settings-input" readonly>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; border-top: 1px dashed var(--color-card-border); padding-top: 1rem;">
                    <label class="settings-label" for="relax-view-file">メディアファイルを選択</label>
                    <input type="file" id="relax-view-file" accept="image/*,video/*" class="settings-input">
                    <div id="relax-view-file-info"></div>
                </div>
            </div>

            <!-- ショートカット -->
            <div class="settings-section">
                <h3>ショートカット</h3>
                <div class="form-row">
                    <input type="text" id="shortcut-name" class="settings-input" placeholder="名前">
                    <input type="url" id="shortcut-url" class="settings-input" placeholder="https://~">
                </div>
                <button id="add-shortcut-btn" class="btn" style="width:100%;">ショートカットを追加</button>
                <ul id="shortcuts-list" class="shortcuts-list" style="margin-top:1rem;"></ul>
            </div>

            <!-- メモ帳 -->
            <div class="settings-section">
                <h3>メモ帳</h3>
                <textarea id="memo-pad" class="settings-textarea" placeholder="ここにメモを入力..."></textarea>
            </div>
        </div>
    </div>
    
    <div id="relax-view-layer"></div>

<script>
/* 
==========================================================================
JavaScript
==========================================================================
*/
document.addEventListener('DOMContentLoaded', () => {

    const projects = [
        { title: 'Prompt Hub Pro', description: '次世代のAI体験を補助する、革新的なプロンプト管理サービス。', url: 'https://peipei2020x.github.io/PHub/', icon: '💻', category: 'main', tags: ['prompt', 'management', 'ForAI'] },
        { title: 'Viewer Ultimate', description: '各自の画像を有用なユーザー体験へ、アルティメットビュアー。', url: 'https://peipei2020x.github.io/VU/', icon: '📷', category: 'main', tags: ['Go', 'Images Viewer', 'Many images'] },
        { title: '準備中', description: '概要', url: 'https://peipei2020x.github.io/', icon: '🎨', category: 'fun', tags: ['1', '2'] },
        { title: '準備中', description: '概要', url: 'https://peipei2020x.github.io/', icon: '😂', category: 'fun', tags: ['1', '2', '3'] },
    ];

    // ========================================================================
    // 機能の実装
    // ========================================================================

    const getEl = (id) => document.getElementById(id);
    const queryEl = (selector) => document.querySelector(selector);

    // DOM要素
    const mainProjectsGrid = getEl('main-projects-grid');
    const funProjectsGrid = getEl('fun-projects-grid');
    const themeSwitcher = getEl('theme-switcher');
    const clearStorageButton = getEl('clear-storage-button');
    const currentYearSpan = getEl('current-year');
    const cursorAura = getEl('cursor-aura');
    const logoElement = queryEl('.logo');
    const clockElement = getEl('realtime-clock');
    const searchSection = getEl('google-search-section');
    const settingsModal = getEl('settings-modal');
    const relaxViewLayer = getEl('relax-view-layer');

    // 設定パネル内の要素
    const toggleClockCheck = getEl('toggle-clock');
    const toggleSearchCheck = getEl('toggle-search');
    const toggleRelaxEnabledCheck = getEl('toggle-relax-view-enabled');
    const toggleRelaxAudio = getEl('toggle-relax-audio');
    const relaxTriggerSelect = getEl('relax-trigger-select');
    const relaxKeyInput = getEl('relax-key-input');
    const relaxViewFileInput = getEl('relax-view-file');
    const relaxViewFileInfo = getEl('relax-view-file-info');
    const shortcutNameInput = getEl('shortcut-name');
    const shortcutUrlInput = getEl('shortcut-url');
    const addShortcutBtn = getEl('add-shortcut-btn');
    const shortcutsList = getEl('shortcuts-list');
    const memoPad = getEl('memo-pad');

    // キーと状態管理
    const STORAGE_KEYS = {
        theme: 'pering-portal-theme',
        settings: 'pering-portal-settings',
        dbName: 'pering-relax-view-db',
        dbStore: 'media-store',
        dbKey: 'relax-media-file'
    };
    let settings = {};
    let relaxViewMediaObjectURL = null;
    let isRelaxViewKeyDown = false;

    // --- IndexedDB ヘルパー ---
    function openDb() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(STORAGE_KEYS.dbName, 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORAGE_KEYS.dbStore)) {
                    db.createObjectStore(STORAGE_KEYS.dbStore);
                }
            };
            request.onsuccess = e => resolve(e.target.result);
            request.onerror = e => reject(e.target.error);
        });
    }

    async function dbAction(type, data = null) {
        const db = await openDb();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(STORAGE_KEYS.dbStore, type === 'get' ? 'readonly' : 'readwrite');
            const store = transaction.objectStore(STORAGE_KEYS.dbStore);
            let request;
            if (type === 'get') request = store.get(STORAGE_KEYS.dbKey);
            else if (type === 'put') request = store.put(data, STORAGE_KEYS.dbKey);
            else if (type === 'delete') request = store.delete(STORAGE_KEYS.dbKey);
            else if (type === 'clear') request = store.clear();
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = e => reject(e.target.error);
        });
    }

    // --- カード生成 ---
    function createCardHTML(project) { const tagsHTML = project.tags.map(tag => `<span class="card-tag">${tag}</span>`).join(''); return ` <div class="card-icon">${project.icon}</div> <h3 class="card-title">${project.title}</h3> <p class="card-description">${project.description}</p> <div class="card-tags">${tagsHTML}</div> `; }
    function renderProjectCards() { if (!mainProjectsGrid || !funProjectsGrid) return; mainProjectsGrid.innerHTML = ''; funProjectsGrid.innerHTML = ''; projects.forEach(project => { const card = document.createElement('a'); card.href = project.url; card.target = '_blank'; card.rel = 'noopener noreferrer'; card.className = 'portal-card'; card.innerHTML = createCardHTML(project); (project.category === 'main' ? mainProjectsGrid : funProjectsGrid).appendChild(card); }); }

    // --- テーマ管理 ---
    function applyTheme(theme) { document.documentElement.classList.toggle('dark-theme', theme === 'dark'); }
    function toggleTheme() { const currentTheme = document.documentElement.classList.contains('dark-theme') ? 'dark' : 'light'; const newTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(STORAGE_KEYS.theme, newTheme); applyTheme(newTheme); }
    function initializeTheme() { const savedTheme = localStorage.getItem(STORAGE_KEYS.theme) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); applyTheme(savedTheme); }

    // --- 設定の保存と読み込み ---
    function saveSettings() { localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings)); }
    
    async function loadAndApplyData() {
        // 1. 基本設定をLocalStorageから読み込む
        const defaultSettings = {
            showClock: true, showSearch: true,
            relaxView: { enabled: false, audio: false, trigger: 'toggle', key: 'Space', mediaFileName: null }, // ファイル名を保存
            shortcuts: [], memo: ''
        };
        const savedSettings = JSON.parse(localStorage.getItem(STORAGE_KEYS.settings));
        settings = { ...defaultSettings, ...savedSettings, relaxView: { ...defaultSettings.relaxView, ...(savedSettings ? savedSettings.relaxView : {}) } };

        // 2. IndexedDBからメディアファイル（Blob）を読み込む
        try {
            if (settings.relaxView.mediaFileName) { // ファイル名が保存されていれば
                const fileBlob = await dbAction('get');
                if (fileBlob) {
                    // 3. ページ読み込みのたびに新しい一時URLを生成する
                    relaxViewMediaObjectURL = URL.createObjectURL(fileBlob);
                } else {
                    // DBにデータがない場合は設定をクリア
                    settings.relaxView.mediaFileName = null;
                    saveSettings();
                }
            }
        } catch (error) { 
            console.error('Failed to load file from IndexedDB:', error);
            settings.relaxView.mediaFileName = null;
            saveSettings();
        }

        // 4. すべてのデータが揃った状態でUIに反映する
        applyAllSettings();
    }
    
    function applyAllSettings() {
        clockElement.classList.toggle('is-hidden', !settings.showClock);
        toggleClockCheck.checked = settings.showClock;
        searchSection.classList.toggle('is-hidden', !settings.showSearch);
        toggleSearchCheck.checked = settings.showSearch;
        
        const { enabled, audio, trigger, key, mediaFileName } = settings.relaxView;
        toggleRelaxEnabledCheck.checked = enabled;
        toggleRelaxAudio.checked = audio;
        relaxTriggerSelect.value = trigger;
        relaxKeyInput.value = key;
        
        updateRelaxViewFileInfo(mediaFileName); // ファイル名でUIを更新
        updateRelaxViewLayer(); // メディアオブジェクトでレイヤーを更新
        
        renderShortcuts();
        memoPad.value = settings.memo;
    }

    // --- リラックスビュー機能 ---
    function updateRelaxViewLayer() {
        relaxViewLayer.innerHTML = '';
        if (relaxViewMediaObjectURL) {
            const isVideo = settings.relaxView.mediaFileName.match(/\.(mp4|webm|mov)$/i);
            const mediaEl = document.createElement(isVideo ? 'video' : 'img');
            mediaEl.src = relaxViewMediaObjectURL;
            if (isVideo) {
                mediaEl.autoplay = true;
                mediaEl.loop = true;
                mediaEl.muted = !settings.relaxView.audio;
                mediaEl.playsInline = true;
            }
            relaxViewLayer.appendChild(mediaEl);
        }
    }

    function handleRelaxView(show) {
        if (show && !relaxViewMediaObjectURL) return;
        relaxViewLayer.classList.toggle('is-open', show);
        const video = relaxViewLayer.querySelector('video');
        if (video) {
            if (show) video.play().catch(e => console.error("Video play failed:", e));
            else video.pause();
        }
    }

    function updateRelaxViewFileInfo(fileName) {
        if (fileName) {
            relaxViewFileInfo.innerHTML = `<span>${fileName}</span><button id="clear-relax-file-btn">クリア</button>`;
            getEl('clear-relax-file-btn').addEventListener('click', clearRelaxViewFile);
        } else {
            relaxViewFileInfo.innerHTML = '';
            relaxViewFileInput.value = '';
        }
    }

    async function clearRelaxViewFile() {
        if (relaxViewMediaObjectURL) {
            URL.revokeObjectURL(relaxViewMediaObjectURL);
            relaxViewMediaObjectURL = null;
        }
        settings.relaxView.mediaFileName = null; // 設定からファイル名を削除
        saveSettings();
        try {
            await dbAction('delete');
            updateRelaxViewFileInfo(null);
            updateRelaxViewLayer();
        } catch (error) { console.error('Failed to delete file from IndexedDB:', error); }
    }

    function setupRelaxViewControls() {
        window.addEventListener('keydown', (e) => {
            if (!settings.relaxView.enabled) return;
            const activeEl = document.activeElement;
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(activeEl.tagName) && activeEl.id !== 'relax-key-input') return;
            
            const triggerKey = settings.relaxView.key === 'Space' ? ' ' : settings.relaxView.key;
            if (e.key !== triggerKey) return;
            
            e.preventDefault();
            if (settings.relaxView.trigger === 'toggle') {
                if (isRelaxViewKeyDown) return;
                isRelaxViewKeyDown = true;
                handleRelaxView(!relaxViewLayer.classList.contains('is-open'));
            } else { // hold
                if (isRelaxViewKeyDown) return;
                isRelaxViewKeyDown = true;
                handleRelaxView(true);
            }
        });

        window.addEventListener('keyup', (e) => {
            const triggerKey = settings.relaxView.key === 'Space' ? ' ' : settings.relaxView.key;
            if (e.key !== triggerKey) return;

            isRelaxViewKeyDown = false;
            if (settings.relaxView.trigger === 'hold') {
                handleRelaxView(false);
            }
        });
    }

    // --- ショートカット機能 ---
    function renderShortcuts() { shortcutsList.innerHTML = ''; settings.shortcuts.forEach((shortcut, index) => { const li = document.createElement('li'); li.className = 'shortcut-item'; li.innerHTML = ` <a href="${shortcut.url}" target="_blank" rel="noopener noreferrer">${shortcut.name}</a> <button data-index="${index}" class="delete-shortcut-btn">&times;</button> `; shortcutsList.appendChild(li); }); }
    function addShortcut() { const name = shortcutNameInput.value.trim(); const url = shortcutUrlInput.value.trim(); if (name && url) { settings.shortcuts.push({ name, url }); saveSettings(); renderShortcuts(); shortcutNameInput.value = ''; shortcutUrlInput.value = ''; } }
    function deleteShortcut(index) { settings.shortcuts.splice(index, 1); saveSettings(); renderShortcuts(); }

    // --- 全設定リセット ---
    async function clearAllData() {
        const confirmed = confirm('本当にこのサイトの全設定（テーマ、表示設定、リラックスビュー、ショートカット、メモなど）をリセットしますか？\n※保存したローカルファイルも削除されます。');
        if (confirmed) {
            localStorage.clear();
            try {
                await dbAction('clear');
                alert('全設定がリセットされました。ページを再読み込みします。');
            } catch (error) {
                alert('ローカル設定はリセットされましたが、DBのクリアに失敗しました。');
            } finally {
                location.reload();
            }
        }
    }
    
    // --- その他UI機能 ---
    function setupScrollAnimations() { const cards = document.querySelectorAll('.portal-card'); const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 }); cards.forEach(card => observer.observe(card)); }
    function setupCursorAura() { if (!cursorAura) return; window.addEventListener('mousemove', e => { requestAnimationFrame(() => { cursorAura.style.transform = `translate(${e.clientX - 200}px, ${e.clientY - 200}px)`; }); }); }
    function updateFooterYear() { if (currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); } }
    function setupRealtimeClock() { if (!clockElement) return; function updateClock() { const now = new Date(); clockElement.textContent = now.toLocaleTimeString(); } updateClock(); setInterval(updateClock, 1000); }
    
    // --- 設定パネル制御 ---
    function setupSettingsModal() { if (!logoElement || !settingsModal) return; let clickCount = 0; logoElement.addEventListener('click', () => { clickCount++; if (clickCount === 7) { settingsModal.classList.add('is-open'); clickCount = 0; } }); const closeModal = () => settingsModal.classList.remove('is-open'); settingsModal.querySelector('.modal-overlay').addEventListener('click', closeModal); settingsModal.querySelector('.modal-close-btn').addEventListener('click', closeModal); }

    // --- イベントリスナー設定 ---
    function setupEventListeners() {
        themeSwitcher.addEventListener('click', toggleTheme);
        clearStorageButton.addEventListener('click', clearAllData);

        // 設定パネル
        toggleClockCheck.addEventListener('change', (e) => { settings.showClock = e.target.checked; saveSettings(); clockElement.classList.toggle('is-hidden', !settings.showClock); });
        toggleSearchCheck.addEventListener('change', (e) => { settings.showSearch = e.target.checked; saveSettings(); searchSection.classList.toggle('is-hidden', !settings.showSearch); });
        
        // リラックスビュー設定
        toggleRelaxEnabledCheck.addEventListener('change', (e) => { settings.relaxView.enabled = e.target.checked; saveSettings(); });
        toggleRelaxAudio.addEventListener('change', (e) => { settings.relaxView.audio = e.target.checked; saveSettings(); updateRelaxViewLayer(); });
        relaxTriggerSelect.addEventListener('change', (e) => { settings.relaxView.trigger = e.target.value; saveSettings(); });
        relaxKeyInput.addEventListener('focus', (e) => { e.target.value = 'キーを押してください...'; });
        relaxKeyInput.addEventListener('blur', (e) => { e.target.value = settings.relaxView.key; });
        relaxKeyInput.addEventListener('keydown', (e) => {
            e.preventDefault();
            const key = e.key === ' ' ? 'Space' : e.key;
            e.target.value = key;
            settings.relaxView.key = key;
            saveSettings();
        });

        relaxViewFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                if (relaxViewMediaObjectURL) URL.revokeObjectURL(relaxViewMediaObjectURL);
                
                await dbAction('put', file); // ファイル(Blob)をDBに保存
                settings.relaxView.mediaFileName = file.name; // ファイル名を設定に保存
                saveSettings();

                relaxViewMediaObjectURL = URL.createObjectURL(file);
                updateRelaxViewFileInfo(file.name);
                updateRelaxViewLayer();
            } catch (error) { alert('ファイルの保存に失敗しました。'); }
        });
        
        // ショートカット & メモ
        addShortcutBtn.addEventListener('click', addShortcut);
        shortcutsList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-shortcut-btn')) { deleteShortcut(e.target.dataset.index); } });
        memoPad.addEventListener('input', (e) => { settings.memo = e.target.value; saveSettings(); });
    }

    // --- 初期化 ---
    async function init() {
        await loadAndApplyData(); 
        
        initializeTheme();
        setupEventListeners();
        renderProjectCards();
        updateFooterYear();
        setupCursorAura();
        setupRealtimeClock();
        setupSettingsModal();
        setupScrollAnimations();
        setupRelaxViewControls();
    }
    
    init();
});
</script>
</body>
</html>
